<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test - Voice Amplification</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success { background: #2d5a2d; }
        .status.error { background: #5a2d2d; }
        .status.info { background: #2d4a5a; }
        .status.warning { background: #5a4a2d; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .audio-visualizer {
            background: #222;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .audio-bar {
            background: #4CAF50;
            height: 20px;
            width: 100%;
            border-radius: 10px;
            margin: 10px 0;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Audio Test Tool</h1>
        
        <div id="status" class="status info">Ready to test audio capture</div>
        
        <div>
            <button id="startBtn">Start Audio Test</button>
            <button id="stopBtn" disabled>Stop Audio Test</button>
            <button id="testBtn">Test Server Connection</button>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <div>Local Audio Level</div>
                <div class="metric-value" id="localAudioLevel">0.0000</div>
            </div>
            <div class="metric">
                <div>Server Audio Level</div>
                <div class="metric-value" id="serverAudioLevel">0.0000</div>
            </div>
            <div class="metric">
                <div>Server Status</div>
                <div class="metric-value" id="serverStatus">Disconnected</div>
            </div>
            <div class="metric">
                <div>Audio Packets Sent</div>
                <div class="metric-value" id="packetCount">0</div>
            </div>
        </div>
        
        <div class="audio-visualizer">
            <h3>Audio Visualizer</h3>
            <div class="audio-bar" id="audioBar"></div>
            <div>Max Level: <span id="maxLevel">0.0000</span></div>
        </div>
        
        <h3>Debug Log:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const socket = io();
        let audioContext;
        let mediaStream;
        let processor;
        let isProcessing = false;
        let analyser;
        let packetCount = 0;
        let maxLevel = 0;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const testBtn = document.getElementById('testBtn');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Socket events
        socket.on('connect', () => {
            log('‚úÖ Connected to server');
            document.getElementById('serverStatus').textContent = 'Connected';
            updateStatus('Connected to server', 'success');
        });

        socket.on('disconnect', () => {
            log('‚ùå Disconnected from server');
            document.getElementById('serverStatus').textContent = 'Disconnected';
            updateStatus('Disconnected from server', 'error');
        });

        socket.on('ready', (data) => {
            log('‚úÖ Server ready: ' + data.message);
            updateStatus('Server ready', 'success');
        });

        socket.on('processed_audio', (data) => {
            if (data.metrics) {
                document.getElementById('serverAudioLevel').textContent = data.metrics.rms.toFixed(4);
            }
        });

        socket.on('error', (data) => {
            log('‚ùå Server error: ' + data.message);
            updateStatus('Server error: ' + data.message, 'error');
        });

        // Test server connection
        testBtn.addEventListener('click', () => {
            log('üß™ Testing server connection...');
            socket.emit('test', { message: 'Hello server!' });
        });

        // Start audio test
        startBtn.addEventListener('click', async () => {
            try {
                log('üé§ Requesting microphone access...');
                updateStatus('Requesting microphone access...', 'info');

                // Check browser support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia not supported in this browser');
                }

                // Request microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 16000,
                        channelCount: 1
                    }
                });

                log('‚úÖ Microphone access granted');
                
                // Log audio track details
                const audioTracks = mediaStream.getAudioTracks();
                log(`üìä Found ${audioTracks.length} audio tracks`);
                
                audioTracks.forEach((track, index) => {
                    log(`Track ${index}: ${track.label || 'Unknown'} (${track.kind})`);
                    log(`  - enabled: ${track.enabled}, muted: ${track.muted}`);
                    log(`  - settings: ${JSON.stringify(track.getSettings())}`);
                });

                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });

                log(`üéµ Audio context created (sample rate: ${audioContext.sampleRate})`);

                // Create audio source
                const source = audioContext.createMediaStreamSource(mediaStream);
                
                // Create analyser for visualization
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                // Create script processor for audio processing
                processor = audioContext.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    if (!isProcessing) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    const maxLevel = Math.max(...inputData.map(Math.abs));
                    const rmsLevel = Math.sqrt(inputData.reduce((sum, val) => sum + val * val, 0) / inputData.length);
                    
                    // Update local display
                    document.getElementById('localAudioLevel').textContent = maxLevel.toFixed(4);
                    document.getElementById('maxLevel').textContent = maxLevel.toFixed(4);
                    
                    // Update visualizer
                    const barWidth = Math.min(maxLevel * 1000, 100);
                    document.getElementById('audioBar').style.width = barWidth + '%';
                    
                    // Track maximum level
                    if (maxLevel > maxLevel) maxLevel = maxLevel;

                    // Send audio data to server
                    const audioData = Array.from(inputData);
                    const buffer = new Float32Array(audioData);
                    const base64 = arrayBufferToBase64(buffer.buffer);
                    
                    socket.emit('audio_data', { audio: base64 });
                    packetCount++;
                    document.getElementById('packetCount').textContent = packetCount;
                    
                    // Log every 50 packets
                    if (packetCount % 50 === 0) {
                        log(`üì§ Sent ${packetCount} packets - Max: ${maxLevel.toFixed(4)}, RMS: ${rmsLevel.toFixed(4)}`);
                    }
                };

                // Connect audio nodes
                source.connect(processor);
                processor.connect(audioContext.destination);

                isProcessing = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                updateStatus('üé§ Audio test active - speak loudly into microphone', 'success');
                log('‚úÖ Audio processing started - speak into microphone!');

            } catch (err) {
                log('‚ùå Microphone error: ' + err.message);
                updateStatus('‚ùå Microphone Error: ' + err.message, 'error');
                console.error('Microphone error:', err);
            }
        });

        // Stop audio test
        stopBtn.addEventListener('click', () => {
            log('‚èπÔ∏è Stopping audio test...');
            isProcessing = false;
            
            if (processor) {
                processor.disconnect();
                log('‚úÖ Audio processor disconnected');
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => {
                    track.stop();
                    log(`‚úÖ Audio track stopped: ${track.label}`);
                });
            }
            
            if (audioContext) {
                audioContext.close();
                log('‚úÖ Audio context closed');
            }

            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('‚èπÔ∏è Audio test stopped', 'info');
            document.getElementById('localAudioLevel').textContent = '0.0000';
            document.getElementById('audioBar').style.width = '0%';
        });

        // Helper function to convert ArrayBuffer to base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Initial setup
        log('üöÄ Audio test tool loaded');
        log(`üåê Browser: ${navigator.userAgent}`);
        log(`üîä getUserMedia supported: ${!!navigator.mediaDevices?.getUserMedia}`);
        log(`üéµ Web Audio API supported: ${!!window.AudioContext || !!window.webkitAudioContext}`);
        
        // Check for HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            log('‚ö†Ô∏è WARNING: Some browsers require HTTPS for microphone access');
        }
    </script>
</body>
</html>
